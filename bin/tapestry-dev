#!/usr/bin/env node
'use strict'

const path = require('path')
const fs = require('fs')

const tapestry = require('../dist/server.bundle').default
const logger = require('../dist/logger')
const validator = require('../dist/validator').default
const cwd = process.cwd()
const env = 'development'

// transpile any following imports
require('babel-register')({
  presets: ['es2015', 'react']
})

// project tapestry config path
const configPath = path.join(cwd, 'tapestry.config.js')

// check tapestry.config.js exists
if (!fs.existsSync(configPath))
  logger.error(`tapestry.config.js not found in ${cwd}`)

logger.info(`Booting Tapestryâ€¦ \n`)

const config = require(configPath).default

// validate the config object
validator(config, (sanitizedConfig) =>
  // kick off client build & server
  tapestry.boot({
    config: sanitizedConfig,
    cwd,
    env
  })
)
