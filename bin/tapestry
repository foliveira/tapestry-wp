#!/usr/bin/env node

const program = require('commander')
const exec = require('child_process').exec
const path = require('path')
const webpack = require('webpack')
const Server = require('../dist/server').default
const Client = require('../dist/build').default

const pkg = require('../package.json')
const configPath = path.join(process.cwd(), 'tapestry.js')

const cwdCached = process.cwd()

program
  .version(pkg.version)
  .command('build')
  .action(function() {
    process.chdir(path.join(__dirname, '..'))
    exec('babel ' + cwdCached + ' --out-dir ./dist/app --presets=es2015,react  --ignore node_modules,__tests__', (err, stdout, stderr) => {
       if (err) {
         console.error(err)
         return
       }
       console.log(stdout)
       console.log('Built Server')
    })
  })

program
  .command('start')
  .action(function() {
    global.TAPESTRY_PRODUCTION = true
    const config = require('../dist/app/tapestry')
    new Server({ config, cwdCached })
  })

program.parse(process.argv)

var NO_COMMAND_SPECIFIED = program.args.length === 0;

if (NO_COMMAND_SPECIFIED) {
  require('babel-register')({
    "presets": ["es2015", "react"]
  })
  const config = require(configPath)
  new Server({ config, cwdCached })
}
